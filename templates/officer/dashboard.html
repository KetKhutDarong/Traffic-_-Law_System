{% extends "base.html" %}

{% block title %}Officer Dashboard - Traffic Law Expert{% endblock %}

{% block content %}
<h2 class="mb-4">
    <i class="fas fa-badge"></i> Officer Dashboard
</h2>

<div class="alert alert-info border-start border-4 border-info">
    <i class="fas fa-id-badge"></i> <strong>Badge #{{ officer['badge_number'] }}</strong> |
    Department: {{ officer['department'] }} | Area: {{ officer['assigned_area'] }}
</div>

<div class="row mb-4">
    <div class="col-md-3">
        <div class="stat-card">
            <div class="stat-icon text-primary">
                <i class="fas fa-clipboard-list"></i>
            </div>
            <div class="stat-number">{{ total_recorded }}</div>
            <div class="stat-label">Violations Recorded</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card">
            <div class="stat-icon text-success">
                <i class="fas fa-money-bill"></i>
            </div>
            <div class="stat-number">{{ "{:,.0f}".format(collected_fines|default(0)) }} KHR</div>
            <div class="stat-label">Collected Fines</div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-plus-circle"></i> Record New Violation
            </div>
            <div class="card-body">
                <button class="btn btn-danger w-100" data-bs-toggle="modal" data-bs-target="#recordModal">
                    <i class="fas fa-exclamation-circle"></i> Record Violation
                </button>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <i class="fas fa-list"></i> My Recorded Violations
    </div>
    <div class="card-body">
        {% if violations %}
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Driver</th>
                        <th>Plate</th>
                        <th>Vehicle</th>
                        <th>Violations</th>
                        <th>Fine</th>
                        <th>Status</th>
                        <th>Payment</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for v in violations %}
                    <tr>
                        <td>{{ v['created_at'][:10] }}</td>
                        <td><strong>{{ v['driver_name'] or 'N/A' }}</strong></td>
                        <td><code>{{ v['plate_number'] or '-' }}</code></td>
                        <td><span class="badge bg-secondary">{{ v['vehicle_type'] }}</span></td>
                        <td>
                            <small>
                                {% if v['parsed_violations'] %}
                                {% for viol in v['parsed_violations'][:2] %}
                                <div>â€¢ {{ viol }}</div>
                                {% endfor %}
                                {% if v['parsed_violations']|length > 2 %}
                                <div>+{{ v['parsed_violations']|length - 2 }} more</div>
                                {% endif %}
                                {% else %}
                                <em>No violations</em>
                                {% endif %}
                            </small>
                        </td>
                        <td><strong class="text-danger">{{ "{:,.0f}".format(v['total_fine']|default(0)) }} KHR</strong>
                        </td>
                        <td>
                            <span class="badge bg-{{ 'success' if v['status'] == 'confirmed' else 'warning' }}">
                                {{ v['status'].upper() }}
                            </span>
                        </td>
                        <td>
                            <span
                                class="badge bg-{{ 'success' if v['payment_status'] == 'paid' else 'danger' if v['payment_status'] == 'unpaid' else 'warning' }}">
                                {{ v['payment_status'].upper() }}
                            </span>
                        </td>
                        <td>
                            {% if v['payment_status'] == 'unpaid' or v['payment_status'] == 'pending' %}
                            <button class="btn btn-sm btn-success" onclick="markPaid({{ v['id'] }})">
                                <i class="fas fa-check"></i> Mark Paid
                            </button>
                            {% else %}
                            <span class="text-success"><i class="fas fa-check-circle"></i> Paid</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="text-center text-muted py-4">No violations recorded yet.</p>
        {% endif %}
    </div>
</div>

<!-- Record Violation Modal -->
<div class="modal fade" id="recordModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="fas fa-badge"></i> Officer: Record Traffic Violation Observed</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form action="/officer/record-violation" method="POST">
                <div class="modal-body">
                    <!-- <p class="text-muted"><small><i class="fas fa-info-circle"></i> As an officer, record all violations
                            you observe. The system will calculate applicable fines based on traffic laws.</small></p> -->

                    <h6 class="mt-3 mb-3 text-primary"><i class="fas fa-user"></i> Driver Information</h6>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Driver's Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" name="driver_name"
                                placeholder="Enter driver's full name" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Driver's License Number</label>
                            <input type="text" class="form-control" name="license_number" placeholder="License number">
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Vehicle Plate Number <span
                                    class="text-danger">*</span></label>
                            <input type="text" class="form-control" name="plate_number"
                                placeholder="License plate number" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Vehicle Type <span class="text-danger">*</span></label>
                            <select class="form-select" name="vehicle" required>
                                <option value="">-- Select Vehicle --</option>
                                <option value="motorcycle">Motorcycle</option>
                                <option value="car">Car</option>
                                <option value="truck">Truck</option>
                                <option value="bus">Bus</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                    </div>

                    <h6 class="mt-3 mb-3 text-primary"><i class="fas fa-car"></i> Violation Details</h6>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Speed (km/h)</label>
                            <input type="number" class="form-control" name="speed" value="30" min="0" max="200">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Wearing Helmet? (Motorcycles)</label>
                            <select class="form-select" name="helmet">
                                <option value="">-- Select --</option>
                                <option value="yes">Yes</option>
                                <option value="no">No</option>
                            </select>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Valid License?</label>
                            <select class="form-select" name="license">
                                <option value="">-- Select --</option>
                                <option value="yes">Yes</option>
                                <option value="no">No</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Vehicle Registered?</label>
                            <select class="form-select" name="registration">
                                <option value="yes">Yes</option>
                                <option value="no">No</option>
                            </select>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Using Mobile Phone?</label>
                            <select class="form-select" name="phone">
                                <option value="no">No</option>
                                <option value="yes">Yes</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Ran Red Light?</label>
                            <select class="form-select" name="red_light">
                                <option value="no">No</option>
                                <option value="yes">Yes</option>
                            </select>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Signs of Alcohol?</label>
                            <select class="form-select" name="alcohol">
                                <option value="no">No</option>
                                <option value="yes">Yes</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Location</label>
                            <input type="text" class="form-control" name="location"
                                placeholder="e.g., Phnom Penh Downtown, Street Name">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Notes/Description</label>
                        <textarea class="form-control" name="description" rows="3"
                            placeholder="Additional details about the violation..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger"><i class="fas fa-exclamation-circle"></i> Record
                        Violation</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    function markPaid(violationId) {
        if (confirm('Mark this violation as paid?')) {
            window.location.href = '/officer/mark-paid/' + violationId;
        }
    }
</script>
{% endblock %}